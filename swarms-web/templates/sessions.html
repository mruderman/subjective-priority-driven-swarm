{% extends "base.html" %}

{% block title %}Sessions - SWARMS{% endblock %}

{% block extra_head %}
<style>
.sessions-container {
    max-width: 1200px;
    margin: 0 auto;
}

.session-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

.session-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.session-id {
    font-family: monospace;
    font-size: 0.85em;
    color: #6c757d;
}

.session-tags .badge {
    margin-right: 0.25rem;
}

.session-actions {
    display: flex;
    gap: 0.5rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

.new-session-form {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.table-responsive {
    margin-top: 1rem;
}

.session-row:hover {
    background-color: #f8f9fa;
}

.copy-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.copy-btn.copied {
    background-color: #28a745;
    border-color: #28a745;
}

.exports-section {
    margin-top: 2rem;
    display: none;
}

.exports-section.active {
    display: block;
}

.exports-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.exports-list {
    max-height: 300px;
    overflow-y: auto;
}

.export-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: #fff;
}

.export-item:hover {
    background-color: #f8f9fa;
}

.export-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.export-item-info {
    flex: 1;
}

.export-item-actions {
    display: flex;
    gap: 0.5rem;
}

.export-filename {
    font-family: monospace;
    font-size: 0.9em;
    color: #495057;
}

.export-meta {
    font-size: 0.85em;
    color: #6c757d;
}

.export-kind-badge {
    font-size: 0.75em;
}

.exports-empty {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.exports-loading {
    text-align: center;
    padding: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container sessions-container" data-page="sessions">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-list-ul"></i> Session Management
            </h1>
            
            <!-- New Session Form -->
            <div class="new-session-form">
                <h5 class="mb-3">Create New Session</h5>
                <form id="new-session-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="session-title" class="form-label">Session Title (Optional)</label>
                                <input type="text" class="form-control" id="session-title" 
                                       placeholder="Enter a descriptive title for your session">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="session-tags" class="form-label">Tags (Optional)</label>
                                <input type="text" class="form-control" id="session-tags" 
                                       placeholder="Enter tags separated by commas">
                                <div class="form-text">Separate multiple tags with commas</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-plus-circle"></i> Create
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Sessions List -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Sessions
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-sessions">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="loading-spinner" id="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading sessions...</p>
                    </div>
                    
                    <div id="sessions-container">
                        <!-- Sessions will be loaded here -->
                    </div>
                    
                    <div class="empty-state" id="empty-state" style="display: none;">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <h5 class="text-muted mt-3">No sessions found</h5>
                        <p class="text-muted">Create your first session to get started!</p>
                    </div>
                </div>
            </div>
            
            <!-- Exports Section -->
            <div class="exports-section" id="exports-section">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-download"></i> Session Exports
                            <span id="exports-session-title" class="text-muted ms-2"></span>
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" id="close-exports">
                            <i class="bi bi-x"></i> Close
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="exports-loading" id="exports-loading" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading exports...</span>
                        </div>
                        
                        <div id="exports-container">
                            <!-- Exports will be loaded here -->
                        </div>
                        
                        <div class="exports-empty" id="exports-empty" style="display: none;">
                            <i class="bi bi-inbox display-6 text-muted"></i>
                            <p class="text-muted mt-2">No exports found for this session</p>
                            <button class="btn btn-sm btn-primary" id="create-first-export">
                                <i class="bi bi-plus-circle"></i> Create First Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block extra_scripts %}
<script>
// Session management functions
class SessionManager {
    constructor() {
        this.init();
    }
    
    init() {
        this.loadSessions();
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // New session form
        const newSessionForm = document.getElementById('new-session-form');
        if (newSessionForm) {
            newSessionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.createSession();
            });
        }
        
        // Refresh button
        const refreshBtn = document.getElementById('refresh-sessions');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.loadSessions();
            });
        }
    }
    
    async loadSessions() {
        const container = document.getElementById('sessions-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const emptyState = document.getElementById('empty-state');
        
        // Show loading state
        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (container) container.innerHTML = '';
        if (emptyState) emptyState.style.display = 'none';
        
        try {
            const response = await fetch('/api/sessions');
            const sessions = await response.json();
            
            if (!response.ok) {
                throw new Error(sessions.error || 'Failed to load sessions');
            }
            
            // Hide loading state
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            
            if (sessions.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            this.renderSessions(sessions);
            
        } catch (error) {
            console.error('Error loading sessions:', error);
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            this.showToast('Error loading sessions: ' + error.message, 'error');
        }
    }
    
    renderSessions(sessions) {
        const container = document.getElementById('sessions-container');
        if (!container) return;
        
        // Create table
        const table = document.createElement('div');
        table.className = 'table-responsive';
        
        table.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Created</th>
                        <th>Last Updated</th>
                        <th>Tags</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-table-body">
                </tbody>
            </table>
        `;
        
        container.appendChild(table);
        
        // Render session rows
        const tbody = document.getElementById('sessions-table-body');
        sessions.forEach(session => {
            const row = this.createSessionRow(session);
            tbody.appendChild(row);
        });
    }
    
    createSessionRow(session) {
        const row = document.createElement('tr');
        row.className = 'session-row';
        
        const shortId = session.id.substring(0, 8);
        const createdDate = new Date(session.created_at).toLocaleString();
        const updatedDate = new Date(session.last_updated).toLocaleString();
        
        const tagsHtml = session.tags.length > 0 
            ? session.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')
            : '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <span class="session-id" title="${session.id}">${shortId}</span>
                    <button class="btn btn-sm btn-outline-secondary copy-btn ms-2" 
                            data-id="${session.id}" title="Copy full ID">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </td>
            <td>${session.title || '<span class="text-muted">Untitled</span>'}</td>
            <td><small>${createdDate}</small></td>
            <td><small>${updatedDate}</small></td>
            <td class="session-tags">${tagsHtml}</td>
            <td>
                <div class="session-actions">
                    <button class="btn btn-sm btn-primary resume-session"
                            data-id="${session.id}" title="Resume session">
                        <i class="bi bi-play-fill"></i> Resume
                    </button>
                    <button class="btn btn-sm btn-outline-secondary view-exports"
                            data-id="${session.id}" title="View exports">
                        <i class="bi bi-folder2-open"></i> View Exports
                    </button>
                    <button class="btn btn-sm btn-outline-primary export-now"
                            data-id="${session.id}" title="Export now">
                        <i class="bi bi-download"></i> Export Now
                    </button>
                </div>
            </td>
        `;
        
        // Add event listeners
        this.setupRowEventListeners(row, session);
        
        return row;
    }
    
    setupRowEventListeners(row, session) {
        // Copy button
        const copyBtn = row.querySelector('.copy-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.copyToClipboard(session.id, copyBtn);
            });
        }
        
        // Resume button
        const resumeBtn = row.querySelector('.resume-session');
        if (resumeBtn) {
            resumeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.resumeSession(session.id);
            });
        }
        
        // View exports button
        const viewExportsBtn = row.querySelector('.view-exports');
        if (viewExportsBtn) {
            viewExportsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.showExports(session.id, session.title);
            });
        }
        
        // Export now button
        const exportNowBtn = row.querySelector('.export-now');
        if (exportNowBtn) {
            exportNowBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.triggerExport(session.id);
            });
        }
    }
    
    async createSession() {
        const titleInput = document.getElementById('session-title');
        const tagsInput = document.getElementById('session-tags');
        
        const title = titleInput ? titleInput.value.trim() : '';
        const tagsText = tagsInput ? tagsInput.value.trim() : '';
        const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
        
        try {
            const response = await fetch('/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, tags })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to create session');
            }
            
            this.showToast('Session created successfully!', 'success');
            
            // Clear form
            if (titleInput) titleInput.value = '';
            if (tagsInput) tagsInput.value = '';
            
            // Reload sessions list
            this.loadSessions();
            
        } catch (error) {
            console.error('Error creating session:', error);
            this.showToast('Error creating session: ' + error.message, 'error');
        }
    }
    
    async resumeSession(sessionId) {
        try {
            const response = await fetch('/api/sessions/resume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: sessionId })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Session not found');
                }
                throw new Error(result.error || 'Failed to resume session');
            }
            
            if (result.ok) {
                this.showToast('Session resumed successfully!', 'success');
                
                // Redirect to chat page after a short delay
                setTimeout(() => {
                    window.location.href = '/chat';
                }, 1000);
            } else {
                throw new Error(result.error || 'Failed to resume session');
            }
            
        } catch (error) {
            console.error('Error resuming session:', error);
            this.showToast('Error resuming session: ' + error.message, 'error');
        }
    }
    
    copyToClipboard(text, button) {
        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.add('copied');
            
            setTimeout(() => {
                button.innerHTML = originalHtml;
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            this.showToast('Failed to copy to clipboard', 'error');
        });
    }
    
    showToast(message, type = 'info') {
        // Use the same toast system as the main app
        if (window.swarmsApp && window.swarmsApp.showToast) {
            window.swarmsApp.showToast(message, type);
        } else {
            // Fallback toast implementation
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${this.getBootstrapColorClass(type)} border-0`;
            toast.setAttribute('role', 'alert');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    }
    
    getBootstrapColorClass(type) {
        const colorMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'primary'
        };
        return colorMap[type] || 'primary';
    }
    
    // Export-related methods
    async showExports(sessionId, sessionTitle) {
        const exportsSection = document.getElementById('exports-section');
        const exportsContainer = document.getElementById('exports-container');
        const exportsLoading = document.getElementById('exports-loading');
        const exportsEmpty = document.getElementById('exports-empty');
        const exportsSessionTitle = document.getElementById('exports-session-title');
        
        if (!exportsSection || !exportsContainer) return;
        
        // Show loading state
        exportsSection.classList.add('active');
        exportsLoading.style.display = 'block';
        exportsContainer.innerHTML = '';
        exportsEmpty.style.display = 'none';
        exportsSessionTitle.textContent = `(${sessionTitle || 'Untitled Session'})`;
        
        try {
            const response = await fetch(`/api/sessions/${sessionId}/exports`);
            const exports = await response.json();
            
            if (!response.ok) {
                throw new Error(exports.error || 'Failed to load exports');
            }
            
            // Hide loading state
            exportsLoading.style.display = 'none';
            
            if (exports.length === 0) {
                exportsEmpty.style.display = 'block';
                // Set up the "create first export" button
                const createFirstBtn = document.getElementById('create-first-export');
                if (createFirstBtn) {
                    createFirstBtn.onclick = () => this.triggerExport(sessionId);
                }
                return;
            }
            
            this.renderExports(exports, sessionId);
            
        } catch (error) {
            console.error('Error loading exports:', error);
            exportsLoading.style.display = 'none';
            this.showToast('Error loading exports: ' + error.message, 'error');
        }
    }
    
    renderExports(exports, sessionId) {
        const container = document.getElementById('exports-container');
        if (!container) return;
        
        container.innerHTML = '<div class="exports-list"></div>';
        const exportsList = container.querySelector('.exports-list');
        
        exports.forEach(exportItem => {
            const exportElement = this.createExportElement(exportItem, sessionId);
            exportsList.appendChild(exportElement);
        });
    }
    
    createExportElement(exportItem, sessionId) {
        const div = document.createElement('div');
        div.className = 'export-item';
        
        const createdDate = new Date(exportItem.created_at).toLocaleString();
        const sizeKB = Math.round(exportItem.size_bytes / 1024);
        
        const kindIcon = exportItem.kind === 'json' ? 'üìä' : 'üìù';
        const kindLabel = exportItem.kind === 'json' ? 'JSON Summary' : 'Markdown Minutes';
        
        div.innerHTML = `
            <div class="export-item-header">
                <div class="export-item-info">
                    <div class="export-filename">${exportItem.filename}</div>
                    <div class="export-meta">
                        <span class="badge bg-secondary export-kind-badge">${kindIcon} ${kindLabel}</span>
                        <span class="ms-2">Created: ${createdDate}</span>
                        <span class="ms-2">Size: ${sizeKB} KB</span>
                    </div>
                </div>
                <div class="export-item-actions">
                    <button class="btn btn-sm btn-outline-primary download-export"
                            data-session-id="${sessionId}"
                            data-filename="${exportItem.filename}"
                            title="Download ${exportItem.filename}">
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
            </div>
        `;
        
        // Add download event listener
        const downloadBtn = div.querySelector('.download-export');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.downloadExport(sessionId, exportItem.filename);
            });
        }
        
        return div;
    }
    
    async triggerExport(sessionId) {
        try {
            this.showToast('Creating session export...', 'info');
            
            const response = await fetch(`/api/sessions/${sessionId}/export`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Export failed');
            }
            
            if (result.ok) {
                this.showToast('Session exported successfully!', 'success');
                
                // Refresh exports list if currently showing
                const exportsSection = document.getElementById('exports-section');
                if (exportsSection && exportsSection.classList.contains('active')) {
                    // Re-load exports for this session
                    const exportsSessionTitle = document.getElementById('exports-session-title');
                    const sessionTitle = exportsSessionTitle.textContent.replace(/^\((.*)\)$/, '$1');
                    this.showExports(sessionId, sessionTitle);
                }
            } else {
                throw new Error(result.error || 'Export failed');
            }
            
        } catch (error) {
            console.error('Error triggering export:', error);
            this.showToast('Error exporting session: ' + error.message, 'error');
        }
    }
    
    downloadExport(sessionId, filename) {
        // Create a download link and trigger it
        const downloadUrl = `/api/sessions/${sessionId}/exports/${filename}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        this.showToast(`Downloading ${filename}...`, 'info');
    }
}

// Initialize session manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.sessionManager = new SessionManager();
    
    // Set up exports section event listeners
    const closeExportsBtn = document.getElementById('close-exports');
    if (closeExportsBtn) {
        closeExportsBtn.addEventListener('click', () => {
            const exportsSection = document.getElementById('exports-section');
            if (exportsSection) {
                exportsSection.classList.remove('active');
            }
        });
    }
});
</script>
{% endblock %}
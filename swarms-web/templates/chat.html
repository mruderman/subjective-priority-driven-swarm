{% extends "base.html" %}

{% block title %}Chat - SWARMS{% endblock %}

{% block main_class %}container-fluid{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Main Chat Area -->
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <!-- Chat Header -->
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots"></i>
                            <span id="current-topic">Active Conversation</span>
                        </h5>
                        <small class="opacity-75">
                            Mode: <span id="current-mode" class="badge bg-light text-dark">HYBRID</span>
                            <span id="phase-indicator" class="badge bg-secondary ms-1"></span>
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-light btn-sm"
                                onclick="window.location.href='{{ url_for('setup') }}'">
                            <i class="bi bi-gear"></i> New Session
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-light btn-sm dropdown-toggle"
                                    type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/minutes">
                                    <i class="bi bi-file-text"></i> Generate Minutes
                                </a></li>
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/stats">
                                    <i class="bi bi-bar-chart"></i> Show Statistics
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/export all">
                                    <i class="bi bi-download"></i> Export All
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="card-body p-0 position-relative">
                <div id="chat-messages" class="chat-messages">
                    <!-- Welcome message -->
                    <div class="message system">
                        <div class="message-content">
                            <i class="bi bi-robot"></i>
                            Welcome to SWARMS! Your agents will begin responding once you send a message.
                        </div>
                    </div>
                </div>

                <!-- Agent Scores Display -->
                <div id="agent-scores-container" class="agent-scores hidden-by-default" hidden>
                    <h6 class="mb-2">
                        <i class="bi bi-speedometer2"></i> Agent Motivation Scores
                    </h6>
                    <div id="agent-scores"></div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="card-footer bg-light">
                <div class="chat-input-container">
                    <!-- File Attachments Area -->
                    <div id="attachment-preview" class="mb-2" style="display: none;">
                        <div class="d-flex flex-wrap gap-2" id="attachment-chips"></div>
                    </div>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary" type="button" id="attach-button"
                                    title="Attach files" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                <i class="bi bi-paperclip"></i>
                            </button>
                        </div>
                        <textarea id="chat-input" class="form-control chat-input"
                                  placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                                  rows="2" style="border-top-left-radius: 0; border-bottom-left-radius: 0;"></textarea>
                        <button class="btn btn-primary" type="button" id="send-button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>

                    <!-- Hidden file input -->
                    <input type="file" id="file-input" multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.docx,.txt"
                           style="display: none;">

                    <!-- Secretary Commands Quick Access -->
                    <div class="mt-2">
                        <small class="text-muted">Secretary commands:</small>
                        <div class="btn-group btn-group-sm ms-2" role="group">
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/minutes" title="Generate Minutes">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/export minutes" title="Export Minutes">
                                <i class="bi bi-download"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/formal" title="Switch to Formal Mode">
                                <i class="bi bi-briefcase"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/casual" title="Switch to Casual Mode">
                                <i class="bi bi-chat-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="row g-3">
            <!-- Participants Card -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-people"></i> Participants
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="agents-list">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0 small">Setting up agents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secretary Panel -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-file-earmark-text"></i> Secretary
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light btn-sm secretary-command"
                                    data-command="/minutes" title="Generate Minutes">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm secretary-command"
                                    data-command="/stats" title="Show Stats">
                                <i class="bi bi-bar-chart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="secretary-content">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mt-2 mb-0 small">Waiting for conversation to begin...</p>
                            </div>
                        </div>

                        <!-- Secretary Minutes -->
                        <div id="secretary-minutes" style="display: none;"></div>

                        <!-- Secretary Stats -->
                        <div id="secretary-stats" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Export Panel -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-download"></i> Export Options
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export minutes">
                                <i class="bi bi-file-earmark-text"></i> Board Minutes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export casual">
                                <i class="bi bi-chat-heart"></i> Casual Notes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export transcript">
                                <i class="bi bi-file-text"></i> Raw Transcript
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export actions">
                                <i class="bi bi-check-square"></i> Action Items
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export summary">
                                <i class="bi bi-file-bar-graph"></i> Executive Summary
                            </button>
                            <hr class="my-2">
                            <button type="button" class="btn btn-primary btn-sm secretary-command"
                                    data-command="/export all">
                                <i class="bi bi-collection"></i> Complete Package
                            </button>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Exports will be available for download after generation.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Connecting...</span>
                </div>
                <p class="mt-3 mb-0">Connecting to SWARMS server...</p>
            </div>
        </div>
    </div>
</div>

<!-- Export Success Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success"></i> Export Complete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="export-results"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_scripts %}
<script>
document.body.setAttribute('data-page', 'chat');

// Simple self-contained chat functionality
class SimpleChat {
    constructor() {
        this.socket = null;
        this.sessionId = null;
        this.isConnected = false;
        this.agents = [];
        this.pendingAttachments = []; // Store uploaded attachments before sending
        this.exportLabels = {
            formal: 'Formal Minutes',
            casual: 'Casual Notes',
            transcript: 'Conversation Transcript',
            actions: 'Action Items',
            summary: 'Executive Summary',
            data: 'Structured Data'
        };

        this.init();
    }

    init() {
        console.log('Initializing SimpleChat...');

        // Get session info
        this.sessionId = sessionStorage.getItem('sessionId');
        const topic = sessionStorage.getItem('topic');

        if (!this.sessionId) {
            console.log('No session ID found, redirecting to setup...');
            window.location.href = '/setup';
            return;
        }

        console.log('Session ID:', this.sessionId);
        console.log('Topic:', topic);

        // Initialize socket
        // Use mocked socket in test mode if available
        if (window.io && typeof window.io === 'function') {
            this.socket = window.io();
        } else {
            this.socket = io();
        }
        this.setupSocketEvents();

        // Setup UI
        this.setupChatInterface();

        // Handle connection - moved inside setupSocketEvents to prevent duplicate registration
        if (topic) {
            this.topicToStart = topic;
        }
    }

    setupSocketEvents() {
        // Remove all existing listeners first to prevent duplicates
        this.socket.off('connect');
        this.socket.off('disconnect');
        this.socket.off('joined');
        this.socket.off('chat_started');
        this.socket.off('user_message');
        this.socket.off('agent_message');
        this.socket.off('system_message');
        this.socket.off('assessing_agents');
        this.socket.off('agent_scores');
        this.socket.off('phase_change');
        this.socket.off('agent_thinking');
        this.socket.off('export_complete');
        // Secretary related events
        this.socket.off('secretary_minutes');
        this.socket.off('secretary_stats');
        this.socket.off('secretary_status');
        this.socket.off('secretary_activity');
        
        // Connect handler - now inside setupSocketEvents
        this.socket.on('connect', () => {
            console.log('Connected to server');
            this.isConnected = true;
            this.hideConnectionModal();
            this.joinSession();

            if (this.topicToStart) {
                setTimeout(() => {
                    this.startChat(this.topicToStart);
                    this.topicToStart = null; // Clear after use
                }, 1000);
            }
        });

        this.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            this.isConnected = false;
            this.showToast('Disconnected from server', 'warning');
        });

        this.socket.on('joined', (data) => {
            console.log('Joined session:', data.session_id);
        });

        this.socket.on('chat_started', (data) => {
            console.log('Chat started:', data);
            this.handleChatStarted(data);
        });

        this.socket.on('user_message', (data) => {
            this.addMessage(data.speaker, data.message, 'user', data.timestamp);
        });

        this.socket.on('agent_message', (data) => {
            this.addMessage(data.speaker, data.message, 'agent', data.timestamp, data.phase);
            this.hideThinkingIndicator(data.speaker);
        });

        this.socket.on('system_message', (data) => {
            this.addMessage('System', data.message, 'system');
        });

        this.socket.on('assessing_agents', () => {
            this.showAssessmentIndicator();
        });

        this.socket.on('agent_scores', (data) => {
            this.updateAgentScores(data.scores);
        });

        this.socket.on('phase_change', (data) => {
            this.updatePhase(data.phase);
        });

        this.socket.on('agent_thinking', (data) => {
            this.showThinkingIndicator(data.agent, data.phase, data.progress);
        });

        this.socket.on('export_complete', (data) => {
            this.handleExportComplete(data);
        });

        this.socket.on('secretary_status', (data) => {
            this.handleSecretaryStatus(data);
        });

        this.socket.on('secretary_activity', (data) => {
            this.handleSecretaryActivity(data);
        });

        // Minutes payload with rendered text from secretary
        this.socket.on('secretary_minutes', (data) => {
            this.updateSecretaryMinutes(data.minutes);
        });

        this.socket.on('secretary_stats', (data) => {
            const payload = (data && (data.stats ?? data)) || {};
            this.updateSecretaryStats(payload);
        });
    }

    setupChatInterface() {
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');

        if (chatInput && sendButton) {
            // Handle Enter key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });

            // Handle send button click
            sendButton.addEventListener('click', () => {
                this.sendMessage();
            });

            // Auto-resize
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        // Setup file attachment functionality
        if (attachButton && fileInput) {
            // Attach button click handler
            attachButton.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);

                if (files.length > 3) {
                    this.showToast('Maximum 3 files allowed', 'warning');
                    e.target.value = ''; // Clear selection
                    return;
                }

                // Upload each file
                files.forEach(file => {
                    this.uploadFile(file);
                });

                // Clear input after processing
                e.target.value = '';
            });
        }

        // Setup secretary commands
        document.querySelectorAll('.secretary-command').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const command = e.currentTarget.dataset.command;
                this.closeExportModal();
                this.sendMessage(command);
            });
        });

        // Show connection modal initially
        this.showConnectionModal();
    }

    joinSession() {
        if (this.socket && this.sessionId) {
            console.log('Joining session:', this.sessionId);
            this.socket.emit('join_session', { session_id: this.sessionId });
        }
    }

    startChat(topic) {
        if (this.socket && this.sessionId) {
            console.log('Starting chat with topic:', topic);
            this.socket.emit('start_chat', {
                session_id: this.sessionId,
                topic: topic
            });
        }
    }

    getUploadEndpoint() {
        const win = window || {};
        const runId = typeof win.__PLAYWRIGHT_UPLOAD_RUN__ === 'string'
            ? win.__PLAYWRIGHT_UPLOAD_RUN__.trim()
            : '';

        if (runId) {
            const url = new URL(window.location.origin + '/api/uploads');
            url.searchParams.set('run', runId);
            return `${url.pathname}${url.search}`;
        }

        return '/api/uploads';
    }

    extractFilenameFromDisposition(disposition, fallback) {
        if (!disposition || typeof disposition !== 'string') {
            return fallback;
        }

        const encodedMatch = disposition.match(/filename\*=(?:UTF-8'')?([^;]+)/i);
        if (encodedMatch && encodedMatch[1]) {
            try {
                return decodeURIComponent(encodedMatch[1].trim().replace(/^"|"$/g, ''));
            } catch (error) {
                console.warn('Failed to decode filename* from content-disposition', error);
            }
        }

        const quotedMatch = disposition.match(/filename="?([^";]+)"?/i);
        if (quotedMatch && quotedMatch[1]) {
            return quotedMatch[1].trim();
        }

        const plainMatch = disposition.match(/filename=([^;]+)/i);
        if (plainMatch && plainMatch[1]) {
            return plainMatch[1].trim();
        }

        return fallback;
    }

    async handleAttachmentDownload(downloadUrl, filename, mimeType) {
        if (!downloadUrl) {
            return;
        }

        try {
            const resolvedUrl = new URL(downloadUrl, window.location.origin).toString();
            const response = await fetch(resolvedUrl);

            if (!response.ok) {
                throw new Error(`Download failed: ${response.status}`);
            }

            const blobData = await response.blob();
            const effectiveMime = mimeType || blobData.type || 'application/octet-stream';
            const suggestedName = this.extractFilenameFromDisposition(
                response.headers.get('content-disposition'),
                filename || 'download'
            );

            const blob = effectiveMime === blobData.type
                ? blobData
                : new Blob([blobData], { type: effectiveMime });

            const objectUrl = URL.createObjectURL(blob);
            this.showToast(`Download ready: ${suggestedName}`, 'success');

            const anchor = document.createElement('a');
            anchor.href = objectUrl;
            anchor.download = suggestedName;
            anchor.rel = 'noopener';

            document.body.appendChild(anchor);
            anchor.click();
            requestAnimationFrame(() => {
                anchor.remove();
                URL.revokeObjectURL(objectUrl);
            });
        } catch (downloadError) {
            console.error('Failed to trigger attachment download', downloadError);
            this.showToast('Download failed', 'error');
        }
    }

    async uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        // Add session_id if available
        if (this.sessionId) {
            formData.append('session_id', this.sessionId);
        }

        try {
            const response = await fetch(this.getUploadEndpoint(), {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
            }

            const data = await response.json();

            if (data.ok) {
                const downloadUrl = data.download_url || (data.file && data.file.download_url);
                const attachment = Object.assign(
                    {
                        filename: file.name,
                        mime: file.type || 'application/octet-stream',
                        size_bytes: file.size,
                        kind: 'document',
                    },
                    data.file || {}
                );
                attachment.download_url = downloadUrl || attachment.download_url || null;

                this.pendingAttachments.push(attachment);
                this.renderAttachments();
                this.showToast(`Upload complete: ${attachment.filename}`, 'success');
                if (attachment.download_url) {
                    await this.handleAttachmentDownload(
                        attachment.download_url,
                        attachment.filename,
                        attachment.mime
                    );
                }
                return attachment;
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('File upload error:', error);
            this.showToast(`Upload failed: ${error.message}`, 'error');
            return null;
        }
    }

    renderAttachments() {
        const container = document.getElementById('attachment-chips');
        const preview = document.getElementById('attachment-preview');

        if (!container || !preview) return;

        if (this.pendingAttachments.length === 0) {
            preview.style.display = 'none';
            return;
        }

        preview.style.display = 'block';

        container.innerHTML = this.pendingAttachments.map((attachment, index) => {
            let previewHtml = '';

            if (attachment.kind === 'image') {
                // Create object URL for image preview
                const blob = new Blob([`data:${attachment.mime};base64,placeholder`], {type: attachment.mime});
                const url = URL.createObjectURL(blob);
                previewHtml = `<img src="${url}" alt="${attachment.filename}" class="attachment-preview-img" style="max-width: 50px; max-height: 50px; border-radius: 4px;">`;
            } else {
                // Document preview
                previewHtml = `<i class="bi bi-file-earmark-text" style="font-size: 1.2em; color: #6c757d;"></i>`;
            }

            return `
                <div class="attachment-chip badge bg-light text-dark d-flex align-items-center gap-1 p-2" data-index="${index}">
                    ${previewHtml}
                    <span class="small">${attachment.filename}</span>
                    <button type="button" class="btn-close btn-close-sm ms-1" style="flex-shrink: 0;" onclick="simpleChat.removeAttachment(${index})"></button>
                </div>
            `;
        }).join('');
    }

    removeAttachment(index) {
        this.pendingAttachments.splice(index, 1);
        this.renderAttachments();

        if (this.pendingAttachments.length === 0) {
            document.getElementById('attachment-preview').style.display = 'none';
        }
    }

    clearAttachments() {
        this.pendingAttachments = [];
        this.renderAttachments();
        document.getElementById('attachment-preview').style.display = 'none';
    }

    sendMessage(message = null) {
        const chatInput = document.getElementById('chat-input');
        if (!chatInput && !message) return;

        const messageText = message || chatInput.value.trim();
        if (!messageText && this.pendingAttachments.length === 0) return;

        // Prepare message data
        const messageData = {
            session_id: this.sessionId,
            message: messageText || ""
        };

        // Include attachments if any
        if (this.pendingAttachments.length > 0) {
            messageData.attachments = this.pendingAttachments;
        }

        // Clear input if it was from the input field
        if (!message && chatInput) {
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }

        // Send via WebSocket (for real-time chat) or API (for attachments)
        if (this.socket && this.sessionId) {
            if (this.pendingAttachments.length > 0) {
                // For messages with attachments, use the API endpoint
                this.sendMessageWithAttachments(messageData);
            } else {
                // For text-only messages, use WebSocket
                console.log('Sending text message:', messageText);
                this.socket.emit('user_message', messageData);
            }
        }

        // Clear attachments after sending
        this.clearAttachments();
    }

    async sendMessageWithAttachments(messageData) {
        try {
            // First send via API to record with attachments
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            });

            if (!response.ok) {
                throw new Error(`Message send failed: ${response.status}`);
            }

            const data = await response.json();

            if (data.ok) {
                this.showToast(`Message sent with ${data.attachments_count} attachment(s)`, 'success');

                // Also emit via WebSocket for real-time UI update
                this.socket.emit('user_message', {
                    session_id: this.sessionId,
                    message: messageData.message
                });
            } else {
                throw new Error(data.error || 'Message send failed');
            }
        } catch (error) {
            console.error('Message with attachments error:', error);
            this.showToast(`Failed to send message: ${error.message}`, 'error');
        }
    }

    handleChatStarted(data) {
        console.log('Handling chat started:', data);

        this.showToast(`Chat started: ${data.topic}`, 'success');
        this.agents = data.agents || [];

        // Update UI elements
        const topicElement = document.getElementById('current-topic');
        if (topicElement) {
            topicElement.textContent = data.topic;
        }

        const modeElement = document.getElementById('current-mode');
        if (modeElement) {
            modeElement.textContent = data.mode.toUpperCase();
        }

        // Update participants list
        this.updateParticipantsList();
    }

    updateParticipantsList() {
        const agentsList = document.getElementById('agents-list');
        if (agentsList && this.agents.length > 0) {
            console.log('Updating participants list with agents:', this.agents);
            agentsList.innerHTML = this.agents.map(agent => `
                <div class="d-flex justify-content-between align-items-center py-1">
                    <span>${agent.name}</span>
                    <span class="badge bg-primary">Active</span>
                </div>
            `).join('');
        }
    }

    addMessage(speaker, content, type = 'agent', timestamp = null, phase = null) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;

        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;

        const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

        let headerHtml = '';
        if (type !== 'system') {
            headerHtml = `
                <div class="message-header">
                    <span class="message-speaker">
                        ${speaker}
                        ${phase ? `<span class="badge bg-secondary ms-1">${phase}</span>` : ''}
                    </span>
                    <span class="message-timestamp">${timeStr}</span>
                </div>
            `;
        }

        messageElement.innerHTML = `
            ${headerHtml}
            <div class="message-content">${this.formatMessageContent(content)}</div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Show agent scores container when agents respond
        if (type === 'agent') {
            const scoresContainer = document.getElementById('agent-scores-container');
            if (scoresContainer) {
                scoresContainer.style.display = 'block';
            }
        }
    }

    formatMessageContent(content) {
        const escapeHtml = (s) =>
            String(s ?? '').replace(/[&<>"']/g, (c) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
            }[c] || c));

        const escaped = escapeHtml(content);
        return escaped
            .replace(/\n/g, '<br>')
            .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }

    showThinkingIndicator(agentName, phase = null, progress = null) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;

        // Remove existing thinking indicator for this agent
        this.hideThinkingIndicator(agentName);

        const thinkingElement = document.createElement('div');
        thinkingElement.className = 'thinking-indicator';
        thinkingElement.id = `thinking-${agentName}`;

        let progressText = progress ? ` (${progress})` : '';
        let phaseText = phase ? ` - ${phase} thoughts` : '';

        thinkingElement.innerHTML = `
            <i class="bi bi-robot"></i>
            <span>${agentName} is thinking${phaseText}${progressText}</span>
            <div class="thinking-dots">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            </div>
        `;

        messagesContainer.appendChild(thinkingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideThinkingIndicator(agentName) {
        const thinkingElement = document.getElementById(`thinking-${agentName}`);
        if (thinkingElement) {
            thinkingElement.remove();
        }
    }

    showAssessmentIndicator() {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;

        // Remove existing assessment indicator
        const existingIndicator = document.getElementById('assessment-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }

        const assessmentElement = document.createElement('div');
        assessmentElement.className = 'progress-indicator';
        assessmentElement.id = 'assessment-indicator';

        assessmentElement.innerHTML = `
            <div class="spinner"></div>
            <span>Assessing agent motivations...</span>
        `;

        messagesContainer.appendChild(assessmentElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    updateAgentScores(scores) {
        // Remove assessment indicator
        const assessmentIndicator = document.getElementById('assessment-indicator');
        if (assessmentIndicator) {
            assessmentIndicator.remove();
        }

        const scoresContainer = document.getElementById('agent-scores');
        if (!scoresContainer) {
            return;
        }

        const normalizedScores = Array.isArray(scores) ? scores : [];

        scoresContainer.innerHTML = normalizedScores.map(score => `
            <div class="agent-score-item">
                <span class="agent-name">${score.name}</span>
                <div class="score-badges">
                    <span class="score-badge">M: ${score.motivation_score}</span>
                    <span class="score-badge">P: ${score.priority_score}</span>
                </div>
            </div>
        `).join('');

        const scoresWrapper = document.getElementById('agent-scores-container');
        if (scoresWrapper) {
            if (normalizedScores.length > 0) {
                scoresWrapper.hidden = false;
                scoresWrapper.removeAttribute('hidden');
                scoresWrapper.classList.remove('hidden-by-default');
                scoresWrapper.style.removeProperty('display');
            } else {
                scoresWrapper.hidden = true;
                scoresWrapper.setAttribute('hidden', 'true');
                scoresWrapper.classList.add('hidden-by-default');
                scoresWrapper.style.removeProperty('display');
                scoresContainer.innerHTML = '';
            }
        }
    }

    updatePhase(phase) {
        const phaseIndicator = document.getElementById('phase-indicator');
        if (phaseIndicator) {
            const phaseNames = {
                'initial_responses': 'Initial Responses',
                'response_round': 'Response Round',
                'all_speak': 'All Speak Mode',
                'sequential': 'Sequential Mode',
                'pure_priority': 'Pure Priority Mode'
            };

            phaseIndicator.textContent = phaseNames[phase] || phase;
        }
    }

    deriveExportFormat(filePath) {
        if (!filePath) {
            return 'unknown';
        }

        const fileName = filePath.split('/').pop() || filePath;
        const baseName = fileName.replace(/\.[^.]+$/, '').toLowerCase();
        const knownFormats = {
            'board_minutes_formal': 'formal',
            'meeting_notes_casual': 'casual',
            'conversation_transcript': 'transcript',
            'action_items': 'actions',
            'executive_summary': 'summary',
            'structured_data': 'data'
        };

        return knownFormats[baseName] || baseName;
    }

    resolveExportLabel(format) {
        const normalized = (format || 'unknown').toLowerCase();
        if (this.exportLabels[normalized]) {
            return this.exportLabels[normalized];
        }

        return normalized.charAt(0).toUpperCase() + normalized.slice(1);
    }

    handleExportComplete(data) {
        const entries = [];

        if (Array.isArray(data.files)) {
            const formats = Array.isArray(data.formats) ? data.formats : [];
            data.files.forEach((filePath, index) => {
                const format = formats[index] || this.deriveExportFormat(filePath);
                entries.push({ format, file: filePath });
            });
        } else if (data.file) {
            const format = data.format || this.deriveExportFormat(data.file);
            entries.push({ format, file: data.file });
        }

        const resultsContainer = document.getElementById('export-results');
        if (resultsContainer) {
            if (entries.length === 0) {
                resultsContainer.innerHTML = '<p class="text-muted mb-0">No export files returned.</p>';
            } else {
                resultsContainer.innerHTML = entries.map(({ format, file }) => {
                    const label = this.resolveExportLabel(format);
                    return `
                        <div class="export-result" data-export-format="${format}">
                            <a href="${file}" download class="download-export d-flex align-items-center gap-2">
                                <i class="bi bi-file-earmark-arrow-down"></i>
                                <span>${label}</span>
                            </a>
                        </div>
                    `;
                }).join('');
            }
        }

        if (entries.length > 1) {
            this.showToast(`Export complete: ${entries.length} files generated`, 'success');
        } else if (entries.length === 1) {
            const exportLabel = this.resolveExportLabel(entries[0].format);
            this.showToast(`Export complete: ${exportLabel}`, 'success');
        }

        const modalElement = document.getElementById('exportModal');
        if (modalElement && window.bootstrap?.Modal) {
            const modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalElement, { backdrop: false });
            modalInstance.show();
        }
    }

    closeExportModal() {
        const modalElement = document.getElementById('exportModal');
        if (!modalElement) {
            return;
        }

        if (window.bootstrap?.Modal) {
            const modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalElement);
            modalInstance.hide();
        }

        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.style.display = 'none';

        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }

    handleSecretaryStatus(data) {
        console.log('Secretary status update:', data);

        const secretaryContent = document.getElementById('secretary-content');
        if (secretaryContent) {
            secretaryContent.innerHTML = `
                <div class="text-center">
                    <div class="badge bg-success mb-2">${data.status.toUpperCase()}</div>
                    <h6 class="text-success">
                        <i class="bi bi-person-check"></i> ${data.agent_name}
                    </h6>
                    <p class="small text-muted mb-2">Mode: ${data.mode}</p>
                    <p class="small">${data.message}</p>
                </div>
            `;
        }

        this.showToast(data.message, 'success');
    }

    handleSecretaryActivity(data) {
        console.log('Secretary activity:', data);

        const secretaryContent = document.getElementById('secretary-content');
        if (secretaryContent) {
            // Show activity indicator
            const activityClass = data.activity === 'generating' ? 'text-warning' :
                                 data.activity === 'completed' ? 'text-success' : 'text-info';

            secretaryContent.innerHTML = `
                <div class="text-center ${activityClass}">
                    <div class="mb-2">
                        ${data.activity === 'generating' ?
                            '<div class="spinner-border spinner-border-sm" role="status"></div>' :
                            '<i class="bi bi-pencil-square"></i>'
                        }
                    </div>
                    <p class="small mb-0">${data.message}</p>
                </div>
            `;

            // Auto-clear completed messages after 3 seconds
            if (data.activity === 'completed') {
                setTimeout(() => {
                    if (secretaryContent.innerHTML.includes(data.message)) {
                        secretaryContent.innerHTML = `
                            <div class="text-center text-success">
                                <i class="bi bi-check-circle"></i>
                                <p class="small mb-0 mt-2">Ready for more activity...</p>
                            </div>
                        `;
                    }
                }, 3000);
            }
        }
    }

    updateSecretaryMinutes(minutes) {
        const minutesEl = document.getElementById('secretary-minutes');
        const contentEl = document.getElementById('secretary-content');
        if (minutesEl) {
            // Prefer plain text to avoid HTML injections; support simple newlines
            minutesEl.textContent = '';
            const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.margin = '0';
            pre.textContent = minutes || '';
            minutesEl.innerHTML = '';
            minutesEl.appendChild(pre);
            minutesEl.style.display = 'block';
        }
        const statsEl = document.getElementById('secretary-stats');
        if (statsEl) {
            statsEl.style.display = 'none';
        }
        if (contentEl) {
            // Keep a small status panel, but deprioritize it visually when minutes are shown
            // No-op: leave existing content; optionally could clear if needed
        }
    }

    updateSecretaryStats(stats) {
        const statsEl = document.getElementById('secretary-stats');
        if (!statsEl) {
            return;
        }

        // Hide minutes panel to avoid overlapping UIs
        const minutesEl = document.getElementById('secretary-minutes');
        if (minutesEl) {
            minutesEl.style.display = 'none';
        }

        // Accessible live updates
        statsEl.setAttribute('aria-live', 'polite');

        const formatValue = (v) => {
            if (v == null) return '';
            if (typeof v === 'number') return new Intl.NumberFormat().format(v);
            if (Array.isArray(v)) return v.join(', ');
            if (typeof v === 'object') return JSON.stringify(v);
            return String(v);
        };

        const entries = stats && typeof stats === 'object'
            ? Object.entries(stats)
            : [];

        statsEl.innerHTML = '';

        if (entries.length === 0) {
            const emptyState = document.createElement('p');
            emptyState.className = 'small text-muted mb-0';
            emptyState.textContent = 'No statistics available yet.';
            statsEl.appendChild(emptyState);
        } else {
            const list = document.createElement('div');
            list.className = 'd-flex flex-column gap-1';

            entries.forEach(([label, value]) => {
                const row = document.createElement('div');
                row.className = 'd-flex justify-content-between align-items-center';

                const labelSpan = document.createElement('span');
                labelSpan.className = 'text-muted';
                labelSpan.textContent = label;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'fw-semibold';
                valueSpan.textContent = formatValue(value);

                row.appendChild(labelSpan);
                row.appendChild(valueSpan);
                list.appendChild(row);
            });

            statsEl.appendChild(list);
        }

        statsEl.style.display = 'block';
    }

    showConnectionModal() {
        const modal = document.getElementById('connectionModal');
        if (modal) {
            const connectionModal = new bootstrap.Modal(modal);
            connectionModal.show();
        }
    }

    hideConnectionModal() {
        const modal = document.getElementById('connectionModal');
        if (modal) {
            const connectionModal = bootstrap.Modal.getInstance(modal);
            if (connectionModal) {
                connectionModal.hide();
            }
        }
    }

    showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
        }

        const colorMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'primary'
        };
        const bgColor = colorMap[type] || 'primary';

        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${bgColor} border-0`;
        toast.setAttribute('role', 'alert');

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast);
        toast.classList.add('show', 'showing');
        if (typeof requestAnimationFrame === 'function') {
            requestAnimationFrame(() => toast.classList.remove('showing'));
        } else {
            setTimeout(() => toast.classList.remove('showing'), 0);
        }
        toast.style.removeProperty('display');
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => {
            toast.classList.remove('show');
            toast.remove();
        });
    }
}

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.simpleChat = new SimpleChat();
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Enter to send message
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const sendButton = document.getElementById('send-button');
        if (sendButton) {
            sendButton.click();
        }
    }

    // Escape to focus input
    if (e.key === 'Escape') {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.focus();
        }
    }
});
</script>
{% endblock %}

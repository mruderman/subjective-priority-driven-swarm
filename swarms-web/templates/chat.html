{% extends "base.html" %}

{% block title %}Chat - SWARMS{% endblock %}

{% block main_class %}container-fluid{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Main Chat Area -->
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <!-- Chat Header -->
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots"></i> 
                            <span id="current-topic">Active Conversation</span>
                        </h5>
                        <small class="opacity-75">
                            Mode: <span id="current-mode" class="badge bg-light text-dark">HYBRID</span>
                            <span id="phase-indicator" class="badge bg-secondary ms-1"></span>
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-light btn-sm" 
                                onclick="window.location.href='{{ url_for('setup') }}'">
                            <i class="bi bi-gear"></i> New Session
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-light btn-sm dropdown-toggle" 
                                    type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/minutes">
                                    <i class="bi bi-file-text"></i> Generate Minutes
                                </a></li>
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/stats">
                                    <i class="bi bi-bar-chart"></i> Show Statistics
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item secretary-command" href="#" data-command="/export all">
                                    <i class="bi bi-download"></i> Export All
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div class="card-body p-0 position-relative">
                <div id="chat-messages" class="chat-messages">
                    <!-- Welcome message -->
                    <div class="message system">
                        <div class="message-content">
                            <i class="bi bi-robot"></i> 
                            Welcome to SWARMS! Your agents will begin responding once you send a message.
                        </div>
                    </div>
                </div>
                
                <!-- Agent Scores Display -->
                <div id="agent-scores-container" class="agent-scores" style="display: none;">
                    <h6 class="mb-2">
                        <i class="bi bi-speedometer2"></i> Agent Motivation Scores
                    </h6>
                    <div id="agent-scores"></div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="card-footer bg-light">
                <div class="chat-input-container">
                    <!-- File Attachments Area -->
                    <div id="attachment-preview" class="mb-2" style="display: none;">
                        <div class="d-flex flex-wrap gap-2" id="attachment-chips"></div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary" type="button" id="attach-button"
                                    title="Attach files" style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                <i class="bi bi-paperclip"></i>
                            </button>
                        </div>
                        <textarea id="chat-input" class="form-control chat-input"
                                  placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                                  rows="2" style="border-top-left-radius: 0; border-bottom-left-radius: 0;"></textarea>
                        <button class="btn btn-primary" type="button" id="send-button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    
                    <!-- Hidden file input -->
                    <input type="file" id="file-input" multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.docx,.txt"
                           style="display: none;">
                    
                    <!-- Secretary Commands Quick Access -->
                    <div class="mt-2">
                        <small class="text-muted">Secretary commands:</small>
                        <div class="btn-group btn-group-sm ms-2" role="group">
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/minutes" title="Generate Minutes">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/export formal" title="Export Minutes">
                                <i class="bi bi-download"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/formal" title="Switch to Formal Mode">
                                <i class="bi bi-briefcase"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary secretary-command"
                                    data-command="/casual" title="Switch to Casual Mode">
                                <i class="bi bi-chat-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="row g-3">
            <!-- Participants Card -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-people"></i> Participants
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="agents-list">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0 small">Setting up agents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Secretary Panel -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-file-earmark-text"></i> Secretary
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light btn-sm secretary-command" 
                                    data-command="/minutes" title="Generate Minutes">
                                <i class="bi bi-file-text"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm secretary-command" 
                                    data-command="/stats" title="Show Stats">
                                <i class="bi bi-bar-chart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="secretary-content">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mt-2 mb-0 small">Waiting for conversation to begin...</p>
                            </div>
                        </div>
                        
                        <!-- Secretary Minutes -->
                        <div id="secretary-minutes" style="display: none;"></div>
                        
                        <!-- Secretary Stats -->
                        <div id="secretary-stats" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Export Panel -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-download"></i> Export Options
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command"
                                    data-command="/export formal">
                                <i class="bi bi-file-earmark-text"></i> Board Minutes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command" 
                                    data-command="/export casual">
                                <i class="bi bi-chat-heart"></i> Casual Notes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command" 
                                    data-command="/export transcript">
                                <i class="bi bi-file-text"></i> Raw Transcript
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command" 
                                    data-command="/export actions">
                                <i class="bi bi-check-square"></i> Action Items
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm secretary-command" 
                                    data-command="/export summary">
                                <i class="bi bi-file-bar-graph"></i> Executive Summary
                            </button>
                            <hr class="my-2">
                            <button type="button" class="btn btn-primary btn-sm secretary-command" 
                                    data-command="/export all">
                                <i class="bi bi-collection"></i> Complete Package
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Exports will be available for download after generation.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Connecting...</span>
                </div>
                <p class="mt-3 mb-0">Connecting to SWARMS server...</p>
            </div>
        </div>
    </div>
</div>

<!-- Export Success Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success"></i> Export Complete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="export-results"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div id="toast-container" class="toast-container"></div>
{% endblock %}

{% block extra_scripts %}
<script>
document.body.setAttribute('data-page', 'chat');

// Simple self-contained chat functionality
class SimpleChat {
    constructor() {
        this.socket = null;
        this.sessionId = null;
        this.isConnected = false;
        this.agents = [];
        this.pendingAttachments = []; // Store uploaded attachments before sending
        this.latestExportEntries = [];

        this.init();
    }
    
    init() {
        console.log('Initializing SimpleChat...');
        
        // Get session info
        this.sessionId = sessionStorage.getItem('sessionId');
        const topic = sessionStorage.getItem('topic');
        
        if (!this.sessionId) {
            console.log('No session ID found, redirecting to setup...');
            window.location.href = '/setup';
            return;
        }
        
        console.log('Session ID:', this.sessionId);
        console.log('Topic:', topic);
        
        // Initialize socket
        this.socket = io();
        this.setupSocketEvents();
        
        // Setup UI
        this.setupChatInterface();
        
        // Handle connection - moved inside setupSocketEvents to prevent duplicate registration
        if (topic) {
            this.topicToStart = topic;
        }
    }
    
    setupSocketEvents() {
        // Remove all existing listeners first to prevent duplicates
        this.socket.off('connect');
        this.socket.off('disconnect');
        this.socket.off('joined');
        this.socket.off('chat_started');
        this.socket.off('user_message');
        this.socket.off('agent_message');
        this.socket.off('system_message');
        this.socket.off('assessing_agents');
        this.socket.off('agent_scores');
        this.socket.off('phase_change');
        this.socket.off('agent_thinking');
        this.socket.off('export_complete');
        
        // Connect handler - now inside setupSocketEvents
        this.socket.on('connect', () => {
            console.log('Connected to server');
            this.isConnected = true;
            this.hideConnectionModal();
            this.joinSession();
            
            if (this.topicToStart) {
                setTimeout(() => {
                    this.startChat(this.topicToStart);
                    this.topicToStart = null; // Clear after use
                }, 1000);
            }
        });
        
        this.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            this.isConnected = false;
            this.showToast('Disconnected from server', 'warning');
        });
        
        this.socket.on('joined', (data) => {
            console.log('Joined session:', data.session_id);
        });
        
        this.socket.on('chat_started', (data) => {
            console.log('Chat started:', data);
            this.handleChatStarted(data);
        });
        
        this.socket.on('user_message', (data) => {
            this.addMessage(data.speaker, data.message, 'user', data.timestamp);
        });
        
        this.socket.on('agent_message', (data) => {
            this.addMessage(data.speaker, data.message, 'agent', data.timestamp, data.phase);
            this.hideThinkingIndicator(data.speaker);
        });
        
        this.socket.on('system_message', (data) => {
            this.addMessage('System', data.message, 'system');
        });
        
        this.socket.on('assessing_agents', () => {
            this.showAssessmentIndicator();
        });
        
        this.socket.on('agent_scores', (data) => {
            this.updateAgentScores(data.scores);
        });
        
        this.socket.on('phase_change', (data) => {
            this.updatePhase(data.phase);
        });
        
        this.socket.on('agent_thinking', (data) => {
            this.showThinkingIndicator(data.agent, data.phase, data.progress);
        });
        
        this.socket.on('export_complete', (data) => {
            this.handleExportComplete(data);
        });
        
        this.socket.on('secretary_status', (data) => {
            this.handleSecretaryStatus(data);
        });
        
        this.socket.on('secretary_activity', (data) => {
            this.handleSecretaryActivity(data);
        });

        // Minutes payload with rendered text from secretary
        this.socket.on('secretary_minutes', (data) => {
            this.updateSecretaryMinutes(data.minutes);
        });
    }
    
    setupChatInterface() {
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        
        if (chatInput && sendButton) {
            // Handle Enter key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            // Handle send button click
            sendButton.addEventListener('click', () => {
                this.sendMessage();
            });
            
            // Auto-resize
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }
        
        // Setup file attachment functionality
        if (attachButton && fileInput) {
            // Attach button click handler
            attachButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change handler
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                
                if (files.length > 3) {
                    this.showToast('Maximum 3 files allowed', 'warning');
                    e.target.value = ''; // Clear selection
                    return;
                }
                
                // Upload each file
                files.forEach(file => {
                    this.uploadFile(file);
                });
                
                // Clear input after processing
                e.target.value = '';
            });
        }
        
        // Setup secretary commands
        document.querySelectorAll('.secretary-command').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const command = e.currentTarget.dataset.command;
                this.sendMessage(command);
            });
        });
        
        // Show connection modal initially
        this.showConnectionModal();
    }
    
    joinSession() {
        if (this.socket && this.sessionId) {
            console.log('Joining session:', this.sessionId);
            this.socket.emit('join_session', { session_id: this.sessionId });
        }
    }
    
    startChat(topic) {
        if (this.socket && this.sessionId) {
            console.log('Starting chat with topic:', topic);
            this.socket.emit('start_chat', { 
                session_id: this.sessionId, 
                topic: topic 
            });
        }
    }
    
    async uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        // Add session_id if available
        if (this.sessionId) {
            formData.append('session_id', this.sessionId);
        }
        
        try {
            const response = await fetch('/api/uploads', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.ok) {
                this.pendingAttachments.push(data.file);
                this.renderAttachments();
                this.showToast(`File uploaded: ${data.file.filename}`, 'success');
                return data.file;
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('File upload error:', error);
            this.showToast(`Upload failed: ${error.message}`, 'error');
            return null;
        }
    }

    renderAttachments() {
        const container = document.getElementById('attachment-chips');
        const preview = document.getElementById('attachment-preview');
        
        if (!container || !preview) return;
        
        if (this.pendingAttachments.length === 0) {
            preview.style.display = 'none';
            return;
        }
        
        preview.style.display = 'block';
        
        container.innerHTML = this.pendingAttachments.map((attachment, index) => {
            let previewHtml = '';
            
            if (attachment.kind === 'image') {
                // Create object URL for image preview
                const blob = new Blob([`data:${attachment.mime};base64,placeholder`], {type: attachment.mime});
                const url = URL.createObjectURL(blob);
                previewHtml = `<img src="${url}" alt="${attachment.filename}" class="attachment-preview-img" style="max-width: 50px; max-height: 50px; border-radius: 4px;">`;
            } else {
                // Document preview
                previewHtml = `<i class="bi bi-file-earmark-text" style="font-size: 1.2em; color: #6c757d;"></i>`;
            }
            
            return `
                <div class="attachment-chip badge bg-light text-dark d-flex align-items-center gap-1 p-2" data-index="${index}">
                    ${previewHtml}
                    <span class="small">${attachment.filename}</span>
                    <button type="button" class="btn-close btn-close-sm ms-1" style="flex-shrink: 0;" onclick="simpleChat.removeAttachment(${index})"></button>
                </div>
            `;
        }).join('');
    }

    removeAttachment(index) {
        this.pendingAttachments.splice(index, 1);
        this.renderAttachments();
        
        if (this.pendingAttachments.length === 0) {
            document.getElementById('attachment-preview').style.display = 'none';
        }
    }

    clearAttachments() {
        this.pendingAttachments = [];
        this.renderAttachments();
        document.getElementById('attachment-preview').style.display = 'none';
    }

    sendMessage(message = null) {
        const chatInput = document.getElementById('chat-input');
        if (!chatInput && !message) return;
        
        const messageText = message || chatInput.value.trim();
        if (!messageText && this.pendingAttachments.length === 0) return;
        
        // Prepare message data
        const messageData = {
            session_id: this.sessionId,
            message: messageText || ""
        };
        
        // Include attachments if any
        if (this.pendingAttachments.length > 0) {
            messageData.attachments = this.pendingAttachments;
        }
        
        // Clear input if it was from the input field
        if (!message && chatInput) {
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }
        
        // Send via WebSocket (for real-time chat) or API (for attachments)
        if (this.socket && this.sessionId) {
            if (this.pendingAttachments.length > 0) {
                // For messages with attachments, use the API endpoint
                this.sendMessageWithAttachments(messageData);
            } else {
                // For text-only messages, use WebSocket
                console.log('Sending text message:', messageText);
                this.socket.emit('user_message', messageData);
            }
        }
        
        // Clear attachments after sending
        this.clearAttachments();
    }

    async sendMessageWithAttachments(messageData) {
        try {
            // First send via API to record with attachments
            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            });
            
            if (!response.ok) {
                throw new Error(`Message send failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.ok) {
                this.showToast(`Message sent with ${data.attachments_count} attachment(s)`, 'success');
                
                // Also emit via WebSocket for real-time UI update
                this.socket.emit('user_message', {
                    session_id: this.sessionId,
                    message: messageData.message
                });
            } else {
                throw new Error(data.error || 'Message send failed');
            }
        } catch (error) {
            console.error('Message with attachments error:', error);
            this.showToast(`Failed to send message: ${error.message}`, 'error');
        }
    }
    
    handleChatStarted(data) {
        console.log('Handling chat started:', data);
        
        this.showToast(`Chat started: ${data.topic}`, 'success');
        this.agents = data.agents || [];
        
        // Update UI elements
        const topicElement = document.getElementById('current-topic');
        if (topicElement) {
            topicElement.textContent = data.topic;
        }
        
        const modeElement = document.getElementById('current-mode');
        if (modeElement) {
            modeElement.textContent = data.mode.toUpperCase();
        }
        
        // Update participants list
        this.updateParticipantsList();
    }
    
    updateParticipantsList() {
        const agentsList = document.getElementById('agents-list');
        if (agentsList && this.agents.length > 0) {
            console.log('Updating participants list with agents:', this.agents);
            agentsList.innerHTML = this.agents.map(agent => `
                <div class="d-flex justify-content-between align-items-center py-1">
                    <span>${agent.name}</span>
                    <span class="badge bg-primary">Active</span>
                </div>
            `).join('');
        }
    }
    
    addMessage(speaker, content, type = 'agent', timestamp = null, phase = null) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        
        const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        
        let headerHtml = '';
        if (type !== 'system') {
            headerHtml = `
                <div class="message-header">
                    <span class="message-speaker">
                        ${speaker}
                        ${phase ? `<span class="badge bg-secondary ms-1">${phase}</span>` : ''}
                    </span>
                    <span class="message-timestamp">${timeStr}</span>
                </div>
            `;
        }
        
        messageElement.innerHTML = `
            ${headerHtml}
            <div class="message-content">${this.formatMessageContent(content)}</div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Show agent scores container when agents respond
        if (type === 'agent') {
            const scoresContainer = document.getElementById('agent-scores-container');
            if (scoresContainer) {
                scoresContainer.style.display = 'block';
            }
        }
    }
    
    formatMessageContent(content) {
        return content
            .replace(/\n/g, '<br>')
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    
    showThinkingIndicator(agentName, phase = null, progress = null) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;
        
        // Remove existing thinking indicator for this agent
        this.hideThinkingIndicator(agentName);
        
        const thinkingElement = document.createElement('div');
        thinkingElement.className = 'thinking-indicator';
        thinkingElement.id = `thinking-${agentName}`;
        
        let progressText = progress ? ` (${progress})` : '';
        let phaseText = phase ? ` - ${phase} thoughts` : '';
        
        thinkingElement.innerHTML = `
            <i class="bi bi-robot"></i>
            <span>${agentName} is thinking${phaseText}${progressText}</span>
            <div class="thinking-dots">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            </div>
        `;
        
        messagesContainer.appendChild(thinkingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    hideThinkingIndicator(agentName) {
        const thinkingElement = document.getElementById(`thinking-${agentName}`);
        if (thinkingElement) {
            thinkingElement.remove();
        }
    }
    
    showAssessmentIndicator() {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;
        
        // Remove existing assessment indicator
        const existingIndicator = document.getElementById('assessment-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        const assessmentElement = document.createElement('div');
        assessmentElement.className = 'progress-indicator';
        assessmentElement.id = 'assessment-indicator';
        
        assessmentElement.innerHTML = `
            <div class="spinner"></div>
            <span>Assessing agent motivations...</span>
        `;
        
        messagesContainer.appendChild(assessmentElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    updateAgentScores(scores) {
        // Remove assessment indicator
        const assessmentIndicator = document.getElementById('assessment-indicator');
        if (assessmentIndicator) {
            assessmentIndicator.remove();
        }
        
        // Update scores in sidebar
        const scoresContainer = document.getElementById('agent-scores');
        if (scoresContainer) {
            scoresContainer.innerHTML = scores.map(score => `
                <div class="agent-score-item">
                    <span class="agent-name">${score.name}</span>
                    <div class="score-badges">
                        <span class="score-badge">M: ${score.motivation_score}</span>
                        <span class="score-badge">P: ${score.priority_score}</span>
                    </div>
                </div>
            `).join('');
        }
    }
    
    updatePhase(phase) {
        const phaseIndicator = document.getElementById('phase-indicator');
        if (phaseIndicator) {
            const phaseNames = {
                'initial_responses': 'Initial Responses',
                'response_round': 'Response Round',
                'all_speak': 'All Speak Mode',
                'sequential': 'Sequential Mode',
                'pure_priority': 'Pure Priority Mode'
            };
            
            phaseIndicator.textContent = phaseNames[phase] || phase;
        }
    }
    
    handleExportComplete(data) {
        const entries = this.normalizeExportEntries(data);

        if (entries.length === 0) {
            this.showToast('Export finished but no files were reported.', 'warning');
            return;
        }

        this.latestExportEntries = entries;
        this.renderExportResults(entries);
        this.showExportModal();

        if (entries.length === 1) {
            const label = this.formatExportLabel(entries[0].format);
            this.showToast(`Export complete: ${label}`, 'success');
        } else {
            this.showToast(`Export complete: ${entries.length} files ready to download`, 'success');
        }
    }

    normalizeExportEntries(payload) {
        if (!payload) {
            return [];
        }

        const entries = [];
        const seen = new Set();

        const maybeAddEntry = (rawEntry, formatHint = null) => {
            const normalized = this.normalizeExportEntry(rawEntry, formatHint);
            if (normalized && !seen.has(normalized.filename)) {
                seen.add(normalized.filename);
                entries.push(normalized);
            }
        };

        if (Array.isArray(payload.files)) {
            payload.files.forEach((item) => maybeAddEntry(item));
        }

        if (payload.file) {
            maybeAddEntry(payload.file, payload.format || null);
        }

        return entries;
    }

    normalizeExportEntry(rawEntry, formatHint = null) {
        if (!rawEntry) {
            return null;
        }

        let filename = '';
        let format = this.normalizeExportFormat(formatHint);
        let size = null;

        if (typeof rawEntry === 'string') {
            filename = this.extractFilename(rawEntry);
        } else if (typeof rawEntry === 'object') {
            const candidate = rawEntry.filename || rawEntry.name || rawEntry.path;
            if (candidate) {
                filename = this.extractFilename(candidate);
            }
            if (!format && rawEntry.format) {
                format = this.normalizeExportFormat(rawEntry.format);
            }
            if (!format && rawEntry.kind) {
                format = this.normalizeExportFormat(rawEntry.kind);
            }
            if (typeof rawEntry.size_bytes === 'number') {
                size = rawEntry.size_bytes;
            } else if (typeof rawEntry.size === 'number') {
                size = rawEntry.size;
            }
        }

        if (!filename) {
            return null;
        }

        const inferredFormat = format || this.inferFormatFromFilename(filename);

        return {
            filename,
            format: inferredFormat,
            size,
            url: this.buildExportDownloadUrl(filename),
        };
    }

    extractFilename(value) {
        if (!value || typeof value !== 'string') {
            return '';
        }
        const parts = value.split(/\\|\//);
        return parts[parts.length - 1];
    }

    normalizeExportFormat(value) {
        if (!value) {
            return '';
        }
        const normalized = value.toString().trim().toLowerCase();
        if (normalized === 'minutes') {
            return 'formal';
        }
        if (normalized === 'action-items' || normalized === 'action_items') {
            return 'actions';
        }
        return normalized;
    }

    inferFormatFromFilename(filename) {
        const lower = filename.toLowerCase();
        if (lower.includes('board_minutes') || lower.includes('formal')) {
            return 'formal';
        }
        if (lower.includes('meeting_notes') || lower.includes('casual')) {
            return 'casual';
        }
        if (lower.includes('transcript')) {
            return 'transcript';
        }
        if (lower.includes('action')) {
            return 'actions';
        }
        if (lower.includes('summary')) {
            return 'summary';
        }
        if (lower.includes('data') || lower.endsWith('.json')) {
            return 'data';
        }
        return 'download';
    }

    buildExportDownloadUrl(filename) {
        try {
            return `/exports/${encodeURIComponent(filename)}`;
        } catch (error) {
            console.warn('Failed to encode export filename', filename, error);
            return `/exports/${filename}`;
        }
    }

    formatExportLabel(format) {
        const labels = {
            formal: 'Formal Minutes',
            casual: 'Casual Notes',
            transcript: 'Conversation Transcript',
            actions: 'Action Items',
            summary: 'Executive Summary',
            data: 'Structured Data',
            download: 'Download',
        };

        const key = format && labels[format] ? format : 'download';
        return labels[key];
    }

    renderExportResults(entries) {
        const container = document.getElementById('export-results');
        if (!container) {
            return;
        }

        if (!entries || entries.length === 0) {
            container.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    No exports are available yet. Try requesting an export from the secretary.
                </div>
            `;
            return;
        }

        container.innerHTML = entries
            .map((entry) => {
                const label = this.formatExportLabel(entry.format);
                const description = entry.filename;
                const sizeText = entry.size ? ` <span class="text-muted">(${this.formatFileSize(entry.size)})</span>` : '';
                return `
                    <div class="border rounded p-3 mb-2 export-result" data-export-format="${entry.format}" data-export-filename="${entry.filename}">
                        <div class="d-flex justify-content-between align-items-start gap-3">
                            <div>
                                <div class="fw-semibold">${label}</div>
                                <div class="small text-muted">${description}${sizeText}</div>
                            </div>
                            <div>
                                <a class="btn btn-sm btn-outline-primary download-export"
                                   href="${entry.url}"
                                   target="_blank"
                                   rel="noopener"
                                   data-filename="${entry.filename}">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            })
            .join('');
    }

    formatFileSize(size) {
        if (!size || size <= 0) {
            return '';
        }

        const units = ['B', 'KB', 'MB', 'GB'];
        let unitIndex = 0;
        let value = size;

        while (value >= 1024 && unitIndex < units.length - 1) {
            value /= 1024;
            unitIndex += 1;
        }

        return `${value.toFixed(value < 10 ? 1 : 0)} ${units[unitIndex]}`;
    }

    showExportModal() {
        const modalElement = document.getElementById('exportModal');
        if (!modalElement) {
            return;
        }

        const bootstrapLib = window.bootstrap;
        if (bootstrapLib && bootstrapLib.Modal) {
            const modalInstance = typeof bootstrapLib.Modal.getOrCreateInstance === 'function'
                ? bootstrapLib.Modal.getOrCreateInstance(modalElement)
                : new bootstrapLib.Modal(modalElement);
            modalInstance.show();
        } else {
            modalElement.classList.add('show');
            modalElement.style.display = 'block';
            modalElement.removeAttribute('aria-hidden');
        }
    }
    
    handleSecretaryStatus(data) {
        console.log('Secretary status update:', data);
        
        const secretaryContent = document.getElementById('secretary-content');
        if (secretaryContent) {
            secretaryContent.innerHTML = `
                <div class="text-center">
                    <div class="badge bg-success mb-2">${data.status.toUpperCase()}</div>
                    <h6 class="text-success">
                        <i class="bi bi-person-check"></i> ${data.agent_name}
                    </h6>
                    <p class="small text-muted mb-2">Mode: ${data.mode}</p>
                    <p class="small">${data.message}</p>
                </div>
            `;
        }
        
        this.showToast(data.message, 'success');
    }
    
    handleSecretaryActivity(data) {
        console.log('Secretary activity:', data);
        
        const secretaryContent = document.getElementById('secretary-content');
        if (secretaryContent) {
            // Show activity indicator
            const activityClass = data.activity === 'generating' ? 'text-warning' : 
                                 data.activity === 'completed' ? 'text-success' : 'text-info';
            
            secretaryContent.innerHTML = `
                <div class="text-center ${activityClass}">
                    <div class="mb-2">
                        ${data.activity === 'generating' ? 
                            '<div class="spinner-border spinner-border-sm" role="status"></div>' : 
                            '<i class="bi bi-pencil-square"></i>'
                        }
                    </div>
                    <p class="small mb-0">${data.message}</p>
                </div>
            `;
            
            // Auto-clear completed messages after 3 seconds
            if (data.activity === 'completed') {
                setTimeout(() => {
                    if (secretaryContent.innerHTML.includes(data.message)) {
                        secretaryContent.innerHTML = `
                            <div class="text-center text-success">
                                <i class="bi bi-check-circle"></i>
                                <p class="small mb-0 mt-2">Ready for more activity...</p>
                            </div>
                        `;
                    }
                }, 3000);
            }
        }
    }

    updateSecretaryMinutes(minutes) {
        const minutesEl = document.getElementById('secretary-minutes');
        const contentEl = document.getElementById('secretary-content');
        if (minutesEl) {
            // Prefer plain text to avoid HTML injections; support simple newlines
            minutesEl.textContent = '';
            const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.margin = '0';
            pre.textContent = minutes || '';
            minutesEl.innerHTML = '';
            minutesEl.appendChild(pre);
            minutesEl.style.display = 'block';
        }
        if (contentEl) {
            // Keep a small status panel, but deprioritize it visually when minutes are shown
            // No-op: leave existing content; optionally could clear if needed
        }
    }
    
    showConnectionModal() {
        const modal = document.getElementById('connectionModal');
        if (modal) {
            const connectionModal = new bootstrap.Modal(modal);
            connectionModal.show();
        }
    }
    
    hideConnectionModal() {
        const modal = document.getElementById('connectionModal');
        if (modal) {
            const connectionModal = bootstrap.Modal.getInstance(modal);
            if (connectionModal) {
                connectionModal.hide();
            }
        }
    }
    
    showToast(message, type = 'info') {
        console.log('Toast:', message, type);
        
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container';
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '80px';
            toastContainer.style.right = '1rem';
            toastContainer.style.zIndex = '1050';
            document.body.appendChild(toastContainer);
        }
        
        const colorMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'primary'
        };
        const bgColor = colorMap[type] || 'primary';
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${bgColor} border-0`;
        toast.setAttribute('role', 'alert');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast element after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
}

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.simpleChat = new SimpleChat();
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Enter to send message
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const sendButton = document.getElementById('send-button');
        if (sendButton) {
            sendButton.click();
        }
    }
    
    // Escape to focus input
    if (e.key === 'Escape') {
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.focus();
        }
    }
});
</script>
{% endblock %}